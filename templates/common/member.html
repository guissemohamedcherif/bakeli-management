{% extends 'base.html' %}
{% load crispy_forms_tags %} 
{% block content %}


    <!-- Begin Page Content -->
    <div class="container-fluid">

              
 <!-- Divider -->
 <hr class="sidebar-divider">

 <!-- Page Heading -->
 <div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
  <h1 class="h3 mb-0 text-gray-800">Les Membres de la Famille</h1>
  </div>          
<!-- Divider -->
<hr class="sidebar-divider">

<!-- Topbar -->
<nav class="navbar navbar-expand navbar-light bg-light topbar mb-4 static-top shadow">

<!-- Topbar Search -->
<form
    class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
    <div class="input-group">
        <input type="text" class="form-control bg-blue border-10 small" placeholder="Search for..."
            aria-label="Search" aria-describedby="basic-addon2">
        <div class="input-group-append">
            <button class="btn btn-primary" type="button">
                <i class="fas fa-search fa-sm"></i>
            </button>
        </div>
    </div>
</form>

<!-- Topbar Navbar -->
<!-- Page Heading -->
<div class="d-sm-flex align-items-center ">
<button data-toggle="modal" data-target="#myModal2" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
class="fas fa-plus fa-sm text-white-50"></i> Nouveau Membre</button>
</div>

</nav>
<!-- End of Topbar -->
  <table id="memberTable" class="table table-striped data-table">
    <thead>
      <tr style="display:flex;">
        <th class="col-md" style="text-align:center" ><strong>PRENOM</strong></th>
        <th class="col-md" style="text-align:center" ><strong>NOM</strong></th>
        <th class="col-md" style="text-align:center" ><strong>TELEPHONE</strong></th>
        <th class="col-md" style="text-align:center" ><strong>GENRE</strong></th>
        <th class="col-md" style="text-align:center" ><strong>ADRESSE</strong></th>
        <th class="col-md" style="text-align:center" ><strong>AVATAR</strong></th>
        <th class="col-md" style="text-align:center" colspan="2"><strong>ACTIONS</strong></th>
      </tr>
    </thead>
    <tbody>
      {% if persons %}
      {% for person in persons %}
      <tr style="display:flex;" id="person-{{person.id}}">
        <td class="prenomClass posteData col-md" name="prenom" style="text-align:center">{{person.prenom}}</td>
        <td class="nomClass posteData col-md" name="nom" style="text-align:center">{{person.nom}}</td>
        <td class="telClass posteData col-md" name="tel" style="text-align:center">{{person.tel}}</td>
        <td class="genreClass posteData col-md" name="genre" style="text-align:center">{{person.genre}}</td>
        <td class="adressClass posteData col-md" name="adress" style="text-align:center">{{person.adress}}</td>

        {% if person.image %}
        <td class="imgClass posteData col-md" name="img" style="text-align:center"><img src="{{person.image.url}}" width="40px" height="40px"/></td>
        {% endif %}
        <td class="col-md">
            <div class="row">
                <div class="col-sm">
                  <button class="btn btn-info" style="float:right" onClick="editMember({{person.id}})" data-toggle="modal" data-target="#myModal2"><i class="fas fa-edit"></i></button>
                </div>
                <div class="col-sm">
                  <button class="btn btn-warning" style="float: left" onClick="deleteMember({{person.id}})"><i class="fas fa-archive"></i></button>
                </div>
            </div>
        </td>            
    </tr>
      {% endfor %}              
      {% endif %}
    </tbody>
    </table> 


 

        <!-- Modal -->
    <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
          </div>
           
          <div class="modal-body">
              <form method="POST" action='.' id="ajax" enctype="multipart/form-data">
                {% csrf_token %}
                <input class="form-control" id="form-id" type="hidden" name="formId"/>
          <div class="row">
            <div class="col-sm">
              <label >PRENOM</label>
              <input class="form-control" id="prenomId" type="text" name="formPrenom"/>
            </div>
            <div class="col-sm">
            <label >NOM</label>
            <input class="form-control" id="nomId" type="text" name="formNom"/>
            </div>
          </div>
          <hr>
        
          <div class="row">
            <div class="col-sm">
              <label >TELEPHONE</label>
              <input class="form-control" id="telId" type="text" name="formTel"/>
            </div>
              <div class="col-sm">
                <label >GENRE</label>
                <select class="form-control" id="genreId" name="formGenre">   
                  <option value="">--- ---</option>
              <option value="HOMME"> HOMME</option>
              <option value="FEMME"> FEMME</option>
              </select>    
                </div>
          </div>
          <hr> 
           
              <label >ADRESSE</label>
              <textarea class="form-control" id="adressId" type="text" name="formAdress"></textarea>
              <hr>      

                <label>AVATAR</label>
                <input class="form-control" id="imageId" type="FILE" name="formImage"/>
         
          <hr>      
          </div>
          <div class="modal-footer">
              <button id="btn_save" name="btn" type="submit" class="btn btn-primary">Enregistrer</button>
              <button id="btn_close" type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
          </div>
          </form>
        </div>
      </div>
      </div>
      
      
      <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
      <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
      <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

      <script>

      function deleteMember(id){
        var action = confirm("Supprimer Membre ?");
        if (action != false) {
          $.ajax({
              url: '{% url "memberDelete" %}',
              data: {
                  'id': id,
              },
              dataType: 'json',
              success: function (data) {
                  if (data.deleted) {
                    $("#memberTable #person-" + id).remove();
                  }
              }
          });
        }
        }

      </script>

      <script>
        $('#ajax').submit(function() {
          var prenomInput = $('input[name="formPrenom"]').val().trim();
          var nomInput = $('input[name="formNom"]').val().trim();
          var telInput = $('input[name="formTel"]').val().trim();
          var telInput = $('input[name="formTel"]').val().trim();
          var adressInput = $('#adressId').val().trim();
          var genreInput= $('#genreId').val().trim()
          var temoin = $('#btn_save').text();
          var compare = temoin.localeCompare('Enregistrer');
  
          if(compare == 0)
          {
            if (prenomInput && nomInput && telInput && adressInput && genreInput=="HOMME" || genreInput=="FEMME" ) {
          event.preventDefault();
          var data = new FormData($('#ajax').get(0));
          console.log(data)
      
          $.ajax({
              url: '{% url "testcreate" %}', // 
              type: 'POST',
              data: data,
              contentType: 'multipart/form-data',
              processData: false,
              contentType: false,
              success: function(data) {
                  if(data.person){
                    appendToMember(data.person)
                  }
              }
          });
        } 
        else {
            alert("Remplir tous les champs.");
            return false;
        }
        $('form#ajax').trigger("reset");
        }
        else{
          if (prenomInput && nomInput && telInput && adressInput && genreInput=="HOMME" || genreInput=="FEMME" ) {
            event.preventDefault();
            var data = new FormData($('#ajax').get(0));
            console.log(data)
        
            $.ajax({
                url: '{% url "updateMember" %}', // 
                type: 'POST',
                data: data,
                contentType: 'multipart/form-data',
                processData: false,
                contentType: false,
                success: function(data) {
                   if(data.person){
                     updateMemberTable(data.person)
                   }
                }
            });
          }else {
            alert("All fields must have a valid value.");
            return false; 
        }
          return false;
        }
      });


        function appendToMember(person){
          $("#memberTable > tbody:last-child").append(`
                  <tr style="display:flex;" id="person-${person.id}">
                    '<td class="prenomClass posteData col-md" name="prenom" style="text-align:center">${person.prenom}</td>
                    '<td class="nomClass posteData col-md" name="nom" style="text-align:center">${person.nom}</td>
                    '<td class="telClass posteData col-md" name="tel" style="text-align:center">${person.tel}</td>
                    '<td class="genreClass posteData col-md" name="genre" style="text-align:center">${person.genre}</td>
                    '<td class="adressClass posteData col-md" name="adress" style="text-align:center">${person.adress}</td>

                    '<td class="imgClass posteData col-md" name="img" style="text-align:center"><img src="${person.image}" width="40px" height="40px"/></td>
                      '<td class="col-md">
                        <div class="row">
                            <div class="col-sm">
                            <button class="btn btn-info" style="float: right"  onClick="editMember({{person.id}})"><i class="fas fa-edit"></i></button>
                            </div>
                            <div class="col-sm">
                            <button class="btn btn-warning" style="float: left" onClick="deleteMember({{person.id}})"><i class="fas fa-archive"></i></button>
                            </div>
                        </div>
                    </td>          
                  </tr>
                    `);
         }

         function editMember(id){
          tr_id = "#person-" + id;
          $('#form-id').val(id);
          $('#prenomId').val($(tr_id).find(".prenomClass").text());
          $('#nomId').val($(tr_id).find(".nomClass").text());
          $('#telId').val($(tr_id).find(".telClass").text());
          $('#adressId').val($(tr_id).find(".adressClass").text());
          $('#genreId').val($(tr_id).find(".genreClass").text());
          $('#imageId').val($(tr_id).find(".imgClass").text());
          $('#btn_save').text('Modifier');     
         }

         function updateMemberTable(person){
         location.reload(true);
         }
      </script>
{% endblock content %}