{% extends 'base.html' %}
{% load static %}
{% block content %}


 <!-- Begin Page Content -->
 <div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
    <h1 class="h3 mb-0 text-gray-800">Employes</h1>
    </div>          
<!-- Divider -->
<hr class="sidebar-divider">
     <!-- Topbar -->
     <nav class="navbar navbar-expand navbar-light bg-light topbar mb-4 static-top shadow">

      <!-- Topbar Search -->
      <form
          class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
          <div class="input-group">
              <input type="text" class="form-control bg-blue border-10 small" placeholder="Search for..."
                  aria-label="Search" aria-describedby="basic-addon2">
              <div class="input-group-append">
                  <button class="btn btn-primary" type="button">
                      <i class="fas fa-search fa-sm"></i>
                  </button>
              </div>
          </div>
      </form>

      <!-- Topbar Navbar -->
     <!-- Page Heading -->
<div class="d-sm-flex align-items-center ">
  <button data-toggle="modal" data-target="#myModal" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
  class="fas fa-plus fa-sm text-white-50"></i> Ajouter un employe</button>
  </div>

  </nav>
  <!-- End of Topbar -->


    <table id="employeTable" class="table table-striped">
        <tr>
          <th>Code</th>
          <th>Nom</th>
          <th>Telephone</th>
          <th>Email</th>
          <th>Poste</th>
          <th>Department</th>
          <th>Statut</th>
          <th style="text-align:center" colspan="2">Actions</th>
        </tr>
        {% if employes %}
        {% for empl in employes %}
        <tr id="employe-{{empl.id}}">
          <td class="codeClass" name="code">{{empl.code}}</td>
          <td class="nomClass" name="nom">{{empl.nom}}</td>
          <td class="telClass" name="tel">{{empl.telephone}}</td>
          <td class="emailClass" name="email">{{empl.email}}</td>
          <td class="posteClass" name="poste">{{empl.poste.abrev}}</td>
          <td style="display:none;" id="idposte" class="posteClass" name="{{empl.poste.id}}"></td>
          <td class="deptClass" name="dept">{{empl.departement.code}}</td>
          <td  class="statutClass" name="stat">{{empl.statut}}</td>
          <td class="align-center">
              <button class="btn btn-success form-control" onClick="editEmp({{empl.id}}, {{empl.poste.id}},{{empl.departement.id}})" data-toggle="modal" data-target="#myModal">MODIFIER</button>
          </td>
          <td class="align-center">
              <button class="btn btn-danger form-control" onClick="deleteEmp({{empl.id}})">SUPPRIMER</button>
          </td>
      </tr>
        {% endfor %}
        {% else %}
          
        {% endif %}
      </table>    
</div>


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
    </div>
     
    <form  id="addemp" action="">
    <div class="modal-body">
        <input class="form-control" id="form-id" type="hidden" name="formId"/>
        <label >CODE</label>
        <input class="form-control" id="form-code" type="text" name="formCode"/><hr>
        <label >NOM</label>
        <input class="form-control" id="form-nom" type="text" name="formNom"/><hr>
        <label >TELEPHONE</label>
        <input class="form-control" id="form-tel" type="text" name="formTel"/><hr>
        <label >EMAIL</label>
        <input type="text" class="form-control" id="form-email" name="formEmail"/><hr>

        <label >STATUT</label>
        <select class="form-control" id="form-statut" name="formStatut">
          <option value=""></option>
          <option value="ACTIVE">ACTIVE</option>
          <option value="INACTIVE">INACTIVE</option>
        </select>
        <hr>
        <label >POSTES</label>
        <select class="form-control" id="form-poste" name="formPoste">
          <option value=""></option>
          {% for rs in results %}
          <option value="{{rs.id}}"> {{rs.designation}}</option>
          {% endfor %}
        </select>
        <hr>
        <label >DEPARTEMENTS</label>
        <select class="form-control" id="form-dept" name="formDept">
          <option value=""></option>
          {% for rs in depts %}
          <option value="{{rs.id}}"> {{rs.nom}}</option>
          {% endfor %}
        </select>
    </div>
    <div class="modal-footer">
        <button id="btn_save" name="btn" type="submit" class="btn btn-primary" >Enregistrer</button>
        <button id="btn_close" type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
    </div>
    </form>
  </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


<script>
  $('#addemp').submit(function() {
   
  var temoin = $('#btn_save').text();
  var codeInput = $('input[name="formCode"]').val().trim();
  var nomInput = $('input[name="formNom"]').val().trim();
  var telInput = $('input[name="formTel"]').val().trim();
  var emailInput = $('input[name="formEmail"]').val().trim();
  var statutInput = $("#form-statut option:selected" ).text();
  var posteInput = $("#form-poste").val();
  var deptInput = $("#form-dept" ).val();

  var compare = temoin.localeCompare('Enregistrer');

    if(compare == 0)
    {
      if (codeInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "emp_create" %}',
            data: {
                'code': codeInput,
                'nom': nomInput,
                'telephone': telInput,
                'email': emailInput,
                'statut': statutInput,
                'poste': posteInput,
                'departement': deptInput 
            },
            
            
            dataType: 'json',
            success: function (data) {
                if (data.employe) {
                  appendToEmpTable (data.employe);
                }
            }
        });
      } else {
        alert("All fields must have a valid value.");
    }
    $('form#addemp').trigger("reset");
    location.reload(true);
    }

    else 
    {
      var idInput = $('input[name="formId"]').val().trim();
      if (codeInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "emp_update" %}',
            data: {
                'id': idInput,
                'code': codeInput,
                'nom': nomInput,
                'tel': telInput,
                'email': emailInput,
                'statut': statutInput,
                'poste': posteInput,
                'departement': deptInput,
            },
            dataType: 'json',
            success: function (data) {
                if (data.employe) {
                  updateToEmpTable(data.employe);
                }
            }
        });
       } else {
        alert("All fields must have a valid value.");
    }
    $('form#addposte').trigger("reset");
    location.reload(true);
    $('#myModal').modal('hide');
    }
  return false; 
 });


 function appendToEmpTable(employe) {

  $("#employeTable > tbody:last-child").append(`
        <tr id="employe-${employe.id}">
            <td  name="code">${employe.code}</td>
            <td  name="nom">${employe.nom}</td>
            <td  name="tel">${employe.tel}</td>
            <td  name="email">${employe.email}</td>
            '<td name="stat">${employe.stat}</td>
            '<td name="poste">${employe.poste.abrev}</td>
            '<td name="dept">${employe.departement.code}</td>
            '<td align="center">
                <button id='edit' class="btn btn-success form-control" onClick="" data-toggle="modal" data-target="#myModal")">MODIFIER</button>
            </td>
            <td align="center">
                <button class="btn btn-danger form-control" onClick="">SUPPRIMER</button>
            </td>
        </tr>
    `);
} 
 
function editEmp(id,id1,id2) {
  if (id) {
    tr_id = "#employe-" + id;
    $('#form-id').val(id);
    $('#form-code').val($(tr_id).find(".codeClass").text());
    $('#form-nom').val($(tr_id).find(".nomClass").text());
    $('#form-tel').val($(tr_id).find(".telClass").text());
    $('#form-email').val($(tr_id).find(".emailClass").text());
    var stat = ($(tr_id).find(".statutClass").text());
    document.getElementById('form-statut').value=stat;

    var post = document.getElementById('form-poste');
    var idT = id1;
    var long = post.options.length;
    var index1=0;
    for (var i=0; i<long; i++) {
        if (post.options[i].value == idT){ 
            index1=i;
            post.value = idT;
            break;
        }
    }
    post.selectedIndex = index1;

    var dept = document.getElementById('form-dept');
    var idT = id2;
    var long = dept.options.length;
    var index=0;
    for (var i=0; i<long; i++) {
        if (dept.options[i].value == idT){ 
            index=i;
            dept.value = idT;
            break;
        }
    }
    dept.selectedIndex = index;
    $('#btn_save').text('Modifier');
  }
}


function deleteEmp(id) {
  var action = confirm("Etes vous sure de vouloir supprimer cet Employe ?");
  if (action != false) {
    $.ajax({
        url: '{% url "emp_delete" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#employeTable #employe-" + id).remove();
            }
        }
    });
  }
}

function updateToEmpTable(departement){
  $("#employeTable #employe-" + employe.id).children('.posteData').each(function() {
      var attr = $(this).attr('name');
      if (attr == 'code') {
        $(this).val(employe.code);
      } else if (attr == 'nom') {
        $(this).text(employe.nom);
      }else if (attr == 'email'){
        $(this).text(employe.email);
      }
       else if (attr == 'stat'){
        $(this).text(employe.statut);
      }else if (attr == 'tel'){
        $(this).text(employe.telephone);
      }else if (attr == 'poste'){
        $(this).text(employe.poste.id);
      }else if (attr == 'dept'){
        $(this).text(employe.departement.id);
      }
    });
}

 </script>

{% endblock content %}
