{% extends 'base.html' %}
{% load static %}
{% block content %}

    <!-- Begin Page Content -->
    <div class="container-fluid">

        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
        <h1 class="h3 mb-0 text-gray-800">Postes</h1>
        </div>          
 <!-- Divider -->
 <hr class="sidebar-divider">

   <!-- Page Heading -->
   <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <button data-toggle="modal" data-target="#myModal" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
    class="fas fa-plus fa-sm text-white-50"></i> Ajouter un poste</button>
</div>

        <table id="posteTable" class="table table-striped">
            <tr>
              <th>Name</th>
              <th>Code</th>
              <th>Statut</th>
              <th style="text-align:center" colspan="2">Actions</th>
            </tr>
            {% if postes %}
            {% for poste in postes %}
            <tr id="poste-{{poste.id}}">
              <td class="designationClass posteData" name="design">{{poste.designation}}</td>
              <td class="abrevClass posteData" name="abr">{{poste.abrev}}</td>
              <td  class="statutClass posteData" name="stat">{{poste.statut}}</td>
              <td style="display:none;" class="descriptionClass posteData" name="descript">{{poste.description}}</td>
              <td class="align-center">
                  <button class="btn btn-success form-control" onClick="editPoste({{poste.id}})" data-toggle="modal" data-target="#myModal">MODIFIER</button>
              </td>
              <td class="align-center">
                  <button class="btn btn-danger form-control" onClick="deletePoste({{poste.id}})">SUPPRIMER</button>
              </td>
          </tr>
            {% endfor %}
            {% else %}
              
            {% endif %}
          </table>    
    </div>


  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
        </div>
         
        <form id="addposte" action="">
        <div class="modal-body">
            <input class="form-control" id="form-id" type="hidden" name="formId"/>
            <label >DESIGNATION</label>
            <input class="form-control" id="form-designation" type="text" name="formDesignation"/>
            <hr>
            <label >SHORT NAME</label>
            <input class="form-control" id="form-abrev" type="text" name="formAbrev"/><hr>
            <label >DESCRIPTION</label>
            <textarea class="form-control" id="form-description" name="formDescription"></textarea><hr>
            <label >STATUT</label>
            <select class="form-control" id="form-statut" name="formStatut">
              <option value=""></option>
              <option value="ACTIVE">ACTIVE</option>
              <option value="INACTIVE">INACTIVE</option>
            </select>
        </div>
        <div class="modal-footer">
            <button id="btn_save" name="btn" type="submit" class="btn btn-primary" >Enregistrer</button>
            <button id="btn_close" type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
        </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>
    $('#addposte').submit(function() {

    var temoin = $('#btn_save').text();
    var designationInput = $('input[name="formDesignation"]').val().trim();
    var abrevInput = $('input[name="formAbrev"]').val().trim();
    var descriptionInput = $('#form-description').val();
    var statutInput = $("#form-statut option:selected" ).text();
    var compare = temoin.localeCompare('Enregistrer');

      if(compare == 0)
      {
        if (designationInput && abrevInput && descriptionInput && statutInput) {
          // Create Ajax Call
          $.ajax({
              url: '{% url "poste_create" %}',
              data: {
                  'designation': designationInput,
                  'abrev': abrevInput,
                  'description': descriptionInput,
                  'statut': statutInput 
              },
              
              dataType: 'json',
              success: function (data) {
                  if (data.poste) {
                    appendToPosteTable(data.poste);
                  }
              }
          });
        } else {
          alert("All fields must have a valid value.");
      }
      $('form#addposte').trigger("reset");
      }

      else 
      {
        var idInput = $('input[name="formId"]').val().trim();

        if (designationInput && abrevInput && descriptionInput && statutInput) {
          // Create Ajax Call
          $.ajax({
              url: '{% url "poste_update" %}',
              data: {
                  'id': idInput,
                  'designation': designationInput,
                  'abrev': abrevInput,
                  'description': descriptionInput,
                  'statut': statutInput 
              },
              dataType: 'json',
              success: function (data) {
                  if (data.poste) {
                    updateToPosteTable(data.poste);
                  }
              }
          });
         } else {
          alert("All fields must have a valid value.");
      }
      $('form#addposte').trigger("reset");
      $('#myModal').modal('hide');
      }

    return false; 
   });


  function appendToPosteTable(poste) {
    $("#posteTable > tbody:last-child").append(`
          <tr id="poste-${poste.id}">
              <td  name="designation">${poste.designation}</td>
              '<td name="abrev">${poste.abrev}</td>
              '<td name="statut">${poste.statut}</td>
              '<td align="center">
                  <button id='edit' class="btn btn-success form-control" onClick="editPoste(${poste.id})" data-toggle="modal" data-target="#myModal")">MODIFIER</button>
              </td>
              <td align="center">
                  <button class="btn btn-danger form-control" onClick="deletePoste(${poste.id})">SUPPRIMER</button>
              </td>
          </tr>
      `);
  } 

        function editPoste(id) {
          if (id) {
            tr_id = "#poste-" + id;
            $('#form-id').val(id);
            $('#form-designation').val($(tr_id).find(".designationClass").text());
            $('#form-abrev').val($(tr_id).find(".abrevClass").text());
            $('#form-description').val($(tr_id).find(".descriptionClass").text());
            var stat = ($(tr_id).find(".statutClass").text());
            document.getElementById('form-statut').value=stat;
            $('#btn_save').text('Modifier');
           
          }
        }

        function updateToPosteTable(poste){
          $("#posteTable #poste-" + poste.id).children('.posteData').each(function() {
              var attr = $(this).attr('name');
              if (attr == 'design') {
                $(this).val(poste.designation);
              } else if (attr == 'abr') {
                $(this).text(poste.abrev);
              } else if (attr == 'stat'){
                $(this).text(poste.statut);
              }
            });
            location.reload(true);
      }

      // Delete Django Ajax Call
function deletePoste(id) {
  var action = confirm("Etes vous sure de vouloir supprimer ce poste ?");
  if (action != false) {
    $.ajax({
        url: '{% url "poste_delete" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#posteTable #poste-" + id).remove();
              location.reload(true);
            }
        }
    });
  }
}

  </script>
{% endblock content %}





  
