{% extends 'base.html' %}
{% load static %}
{% block content %}

    <!-- Begin Page Content -->
    <div class="container-fluid">

        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
        <h1 class="h3 mb-0 text-gray-800">Classes</h1>
        </div>          
 <!-- Divider -->
 <hr class="sidebar-divider">

     <!-- Topbar -->
     <nav class="navbar navbar-expand navbar-light bg-light topbar mb-4 static-top shadow">

      <!-- Topbar Search -->
      <form
          class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
          <div class="input-group">
              <input type="text" class="form-control bg-blue border-10 small" placeholder="Search for..."
                  aria-label="Search" aria-describedby="basic-addon2">
              <div class="input-group-append">
                  <button class="btn btn-primary" type="button">
                      <i class="fas fa-search fa-sm"></i>
                  </button>
              </div>
          </div>
      </form>

      <!-- Topbar Navbar -->
     <!-- Page Heading -->
<div class="d-sm-flex align-items-center">
  <button data-toggle="modal" data-target="#myModal" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
  class="fas fa-plus fa-sm text-white-50"></i> Nouvelle Classe</button>
  </div>

  </nav>
  <!-- End of Topbar -->

        <table id="classeTable" class="table table-striped ">
            <tr class="d-flex">
              <th class="col-md" style="text-align:center" ><strong>CLASSES</strong></th>
              <th class="col-md" style="text-align:center" ><strong>NIVEAUX</strong></th>
              <th class="col-md" style="text-align:center" colspan="2"><strong>ACTIONS</strong></th>
            </tr>
            {% if list %}
            {% for classe in list %}
            <tr class="d-flex" id="classe-{{classe.id}}">
              <td class="nomClass posteData col-md" name="nom" style="text-align:center">{{classe.nom}}</td>
              <td class="niveauClass posteData col-md" name="niveau" style="text-align:center">{{classe.niveau.nom}}</td>
              <td class="col-md">
                  <div class="row">
                      <div class="col">
                        <button class="btn btn-success" style="float: right" onClick="editClasse({{classe.id}}, {{classe.niveau.id}})" data-toggle="modal" data-target="#myModal"><i class="fas fa-edit"></i></button>
                      </div>
                      <div class="col">
                        <button class="btn btn-warning" style="float: left" onClick="deleteClasse({{classe.id}})"><i class="fas fa-archive"></i></button>
                      </div>
                  </div>
              </td>            
          </tr>
            {% endfor %}              
            {% endif %}
          </table>    
    </div>

      <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
        </div>    
        <form id="addclasse" action="">
        <div class="modal-body">
            <input class="form-control" id="form-id" type="hidden" name="formId"/>
            <label >NOM</label>
            <input class="form-control" id="form-nom" type="text" name="formNom"/>
            <hr>
            <label >NIVEAU</label>
            <select class="form-control" id="form-niveau" name="formNiveau">
              <option value=""></option>
              {% for rs in nivs %}
              <option value="{{rs.id}}"> {{rs.nom}}</option>
              {% endfor %}
            </select>
            <hr>
        </div>
        <div class="modal-footer">
            <button id="btn_save" name="btn" type="submit" class="btn btn-primary" >Enregistrer</button>
            <button id="btn_close" onClick="closeAll()" class="btn btn-"type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
        </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


  <script>
    $('#addclasse').submit(function() {

    var temoin = $('#btn_save').text();
    var nomInput = $('input[name="formNom"]').val().trim();
    var niveauInput = $("#form-niveau").val();

    var compare = temoin.localeCompare('Enregistrer');

      if(compare == 0)
      {
        if (nomInput && niveauInput) {
          // Create Ajax Call
          $.ajax({
              url: '{% url "createClasses" user.id %}',
              data: {
                  'nom': nomInput,
                  'niveau': niveauInput,
              },
              
              dataType: 'json',
              success: function (data) {
                  if (data.classe) {
                    appendToClasseTable(data.classe);
                    location.reload(true);
                  }
              }
          });
        } else {
          alert("Remplir tous les champs.");
      }
      $('form#addclasse').trigger("reset");
      $('#myModal').modal('hide');     
     }
     else 
     {
       var idInput = $('input[name="formId"]').val().trim();
       if (nomInput && niveauInput) {
         // Create Ajax Call
         $.ajax({
             url: '{% url "update_classe" %}',
             data: {
                 'id': idInput,
                 'nom': nomInput,
                 'niveau':niveauInput
             },
             dataType: 'json',
             success: function (data) {
                 if (data.classe) {
                   updateToClasseTable(data.classe);
                 }
             }
         });
        } else {
         alert("Remplir tous les champs.");
     }
     $('form#addclasse').trigger("reset");
     $('#myModal').modal('hide');
     }
   });


   function appendToClasseTable(classe) {
    $("#classeTable > tbody:last-child").append(`
          <tr class="d-flex" id="classe-${classe.id}">
              <td class="nomClass col-md"  name="nom" style="text-align:center">${classe.nom}</td>
              <td class="niveauClass col-md" name="niveau" style="text-align:center">${classe.niveau.nom}</td>
              '<td class="col-md">
                <div class="row">
                    <div class="col">
                      <button class="btn btn-success col-md" onClick="editClasse({{classe.id}})" data-toggle="modal" data-target="#myModal">MODIFIER</button>
                    </div>
                    <div class="col">
                      <button class="btn btn-danger col-md" onClick="deleteClasse({{classe.id}})">SUPPRIMER</button>
                    </div>
                </div>
            </td> 
          </tr>
      `);
  } 

  function editClasse(id,id1) {
    if (id) {
      tr_id = "#classe-" + id;
      $('#form-id').val(id);
      $('#form-nom').val($(tr_id).find(".nomClass").text());
  
      var niv = document.getElementById('form-niveau');
      var idT = id1;
      var long = niv.options.length;
      var index1=0;
      for (var i=0; i<long; i++) {
          if (niv.options[i].value == idT){ 
              index1=i;
              niv.value = idT;
              break;
          }
      }
      niv.selectedIndex = index1;
      $('#btn_save').text('Modifier');
    }
  }

  function updateToClasseTable(classe){
    $("#classeTable #classe-" + classe.id).children('.posteData').each(function() {

        var attr = $(this).attr('name');
        if (attr == 'nom') {
          $(this).val(classe.nom);
        } 
        if (attr == 'niveau') {
            $(this).val(classe.niveau);
          }
      });
}

function closeAll() {

  $('#btn_save').text('Enregistrer');
  $('form#addclasse').trigger("reset");
}

function deleteClasse(id) {
  var action = confirm("Supprimer Classe ?");
  if (action != false) {
    $.ajax({
        url: '{% url "delete_classe" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#classeTable #classe-" + id).remove();
            }
        }
    });
  }
}

</script>
    {% endblock content %}